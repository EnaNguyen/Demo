<div class="admin-product-container">
  <!-- Header -->
  <div class="admin-header">
    <h1>Quản Lý Sản Phẩm</h1>
    <button class="btn-add-product" (click)="openCreateModal()">+ Thêm Sản Phẩm</button>
  </div>

  <!-- Filter Section -->
  <div class="filter-section">
    <button class="btn-toggle-filter" (click)="toggleFilter()">
      {{ showFilter() ? 'Ẩn Bộ Lọc' : 'Hiện Bộ Lọc' }}
    </button>

    @if (showFilter()) {
    <div class="filters-wrapper">
      @for (filterOption of filterConfig().request; track filterOption.title) {
      <app-filter-wrapper [filterOption]="filterOption" (filterChange)="onFilterChange($event)">
      </app-filter-wrapper>
      }
    </div>
    }
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <span class="stat"
      >Tổng: <strong>{{ totalItems() }}</strong> sản phẩm</span
    >
    <span class="stat"
      >Hiển thị: <strong>{{ displayedProducts().length }}</strong> / trang</span
    >
    <span class="stat"
      >Trang: <strong>{{ currentPage() }} / {{ totalPages() }}</strong></span
    >
  </div>

  <!-- Products Table -->
  <div class="table-container">
    <table class="products-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Ảnh</th>
          <th>Tên Sản Phẩm</th>
          <th>Thương Hiệu</th>
          <th>Ngày Ra Mắt</th>
          <th>Giá</th>
          <th>Số Lượng</th>
          <th>Tình Trạng</th>
          <th>Thao Tác</th>
        </tr>
      </thead>
      <tbody>
        @for (product of displayedProducts(); track product.id ?? product.key) {
        <tr [class]="getStatusClass(product)">
          <td class="col-id">{{ product.key }}</td>
          <td class="col-image">
            <img
              [src]="getProductImage(product)"
              [alt]="product.label"
              class="product-image"
              (error)="onImageError($event)"
            />
          </td>
          <td class="col-name">{{ product.label }}</td>
          <td class="col-brand">{{ getPropertyValue(product, 'brand') }}</td>
          <td class="col-date">{{ getPropertyValue(product, 'releaseDate') | formatDate }}</td>
          <td class="col-price">{{ getPropertyValue(product, 'price') | formatPrice }}</td>
          <td class="col-quantity">
            <span [ngClass]="'qty-' + (getProductQuantity(product) > 0 ? 'available' : 'empty')">
              {{ getProductQuantity(product) }}
            </span>
          </td>
          <td class="col-status">
            <span [ngClass]="'badge-' + getProductStatus(product).toLowerCase().replace(' ', '-')">
              {{ getProductStatus(product) }}
            </span>
          </td>
          <td class="col-actions">
            <div class="action-dropdown">
              <button
                mat-icon-button
                [matMenuTriggerFor]="actionMenu"
                (click)="$event.stopPropagation()"
              >
                <span class="menu-dots">⋮</span>
              </button>

              <mat-menu #actionMenu="matMenu" xPosition="before" overlapTrigger="false">
                <button mat-menu-item class="menu-item edit" (click)="editProduct(product)">
                  <mat-icon>edit</mat-icon>
                  <span>Sửa</span>
                </button>

                <button
                  mat-menu-item
                  class="menu-item toggle"
                  (click)="toggleProductStatus(product)"
                >
                  <mat-icon>
                    @if (getPropertyValue(product, 'status') == 1) { pause_circle } @else {
                    play_circle }
                  </mat-icon>
                  <span>
                    @if (getPropertyValue(product, 'status') == 1) { Ngừng Bán } @else { Mở Bán }
                  </span>
                </button>
              </mat-menu>
            </div>
          </td>
        </tr>
        } @empty {
        <tr>
          <td colspan="9" class="no-data">
            <p>Không có sản phẩm nào phù hợp với điều kiện tìm kiếm</p>
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination-section">
    <div class="pagination">
      <button class="btn-page" (click)="previousPage()" [disabled]="currentPage() === 1">
        ← Trước
      </button>

      <span class="page-info"> Trang {{ currentPage() }} / {{ totalPages() }} </span>

      <button class="btn-page" (click)="nextPage()" [disabled]="currentPage() >= totalPages()">
        Tiếp Theo →
      </button>
    </div>

    <div class="page-size">
      <label>Hiển thị:</label>
      <select
        [value]="pageSize()"
        (change)="onPageSizeChange($any($event.target).value)"
        class="page-size-select"
      >
        @for (size of pageSizeOptions; track size) {
        <option [value]="size">{{ size }} sản phẩm</option>
        }
      </select>
    </div>
  </div>
</div>

<app-update-product #updateProductModal></app-update-product>
<app-create-product #createProductModal></app-create-product>
